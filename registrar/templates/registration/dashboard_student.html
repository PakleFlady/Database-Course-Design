{% extends "base.html" %}
{% block title %}学生自助服务{% endblock %}
{% block content %}
<h1>学生自助服务</h1>
<p>报名、退课、重修等都可在此发起。左侧概览提供 GPA、学分、审批进度与可选课程数量，方便你快速掌握当前状态。</p>

<div class="grid two">
  <div class="stat-card">
    <div class="stat-label">当前 GPA</div>
    <div class="stat-value">{{ gpa|default:"--" }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">本学期计划学分</div>
    <div class="stat-value">{{ credit_load|default:0 }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">待审批申请</div>
    <div class="stat-value">{{ request_summary.pending }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">可选教学班</div>
    <div class="stat-value">{{ available_sections|length }}</div>
  </div>
</div>

<div class="section">
  <h2>个人档案</h2>
  <div class="hint">
    <strong>{{ profile.user.get_full_name|default:profile.user.username }}</strong> · {{ profile.get_gender_display|default:"未填写" }}<br />
    <span class="muted">学院/专业：{{ profile.college|default:"-" }} / {{ profile.major|default:"-" }}</span><br />
    <span class="muted">联系方式：{{ profile.contact_email|default:"未填写邮箱" }} {% if profile.contact_phone %}/ {{ profile.contact_phone }}{% endif %}</span>
  </div>
</div>

<div class="section">
  <h2>自助办理</h2>
  <div class="hint">
    <strong>说明：</strong> 报名/退课会即时落地；重修、跨院、超学分等事项进入审批流，可在下方“我的申请”查看进度。
  </div>
  <form method="post">
    {% csrf_token %}
    {{ form.non_field_errors }}
    <label for="id_request_type">办理事项</label>
    {{ form.request_type }}
    <label for="id_section">关联教学班</label>
    {{ form.section }}
    <label for="id_reason">说明/备注</label>
    {{ form.reason }}
    <input class="button" type="submit" value="提交申请" />
  </form>
</div>

<div class="section">
  <h2 style="display:flex; justify-content: space-between; align-items: center; gap: 12px;">
    <span>上课时间安排</span>
    <a class="button secondary" href="{% url 'student_schedule_export' %}">导出课表</a>
  </h2>
  <table>
    <thead>
      <tr style="text-align:left; border-bottom:1px solid #e5e7eb;">
        <th>星期</th>
        <th>时间</th>
        <th>课程</th>
        <th>学期</th>
        <th>地点</th>
      </tr>
    </thead>
    <tbody>
      {% for slot in schedule %}
      <tr style="border-bottom:1px solid #f1f5f9;">
        <td>{{ slot.get_day_of_week_display }}</td>
        <td>{{ slot.start_time }} - {{ slot.end_time }}</td>
        <td>{{ slot.section.course.code }} {{ slot.section.course.name }}</td>
        <td>{{ slot.section.semester.code }}</td>
        <td>{{ slot.location|default:"待定" }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="5">暂未有课表安排</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="section">
  <h2>需关注/重修课程</h2>
  <table>
    <thead>
      <tr style="text-align:left; border-bottom:1px solid #e5e7eb;">
        <th>课程</th>
        <th>学期</th>
        <th>状态</th>
        <th>成绩</th>
      </tr>
    </thead>
    <tbody>
      {% for enrollment in failed_enrollments %}
      <tr style="border-bottom:1px solid #f1f5f9;">
        <td>{{ enrollment.section.course.name }}</td>
        <td>{{ enrollment.section.semester.code }}</td>
        <td>{{ enrollment.get_status_display }}</td>
        <td>{{ enrollment.final_grade|default:"-" }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="4">暂无需重修的课程</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="section">
  <h2>已选课程与成绩</h2>
  <table>
    <thead>
      <tr style="text-align:left; border-bottom:1px solid #e5e7eb;">
        <th>课程</th>
        <th>学期</th>
        <th>状态</th>
        <th>成绩</th>
        <th>绩点</th>
      </tr>
    </thead>
    <tbody>
      {% for enrollment in enrollments %}
      <tr style="border-bottom:1px solid #f1f5f9;">
        <td>{{ enrollment.section.course.name }}</td>
        <td>{{ enrollment.section.semester.code }}</td>
        <td>{{ enrollment.get_status_display }}</td>
        <td>{{ enrollment.final_grade|default:"-" }}</td>
        <td>{{ enrollment.grade_points|default:"-" }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="5">暂未有选课记录</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="section">
  <h2>可选教学班</h2>
  <table>
    <thead>
      <tr style="text-align:left; border-bottom:1px solid #e5e7eb;">
        <th>课程</th>
        <th>教师</th>
        <th>学期</th>
        <th>容量</th>
      </tr>
    </thead>
    <tbody>
      {% for section in available_sections %}
      <tr style="border-bottom:1px solid #f1f5f9;">
        <td>{{ section.course.code }} {{ section.course.name }}</td>
        <td>{{ section.instructor.user.get_full_name|default:section.instructor.user.username }}</td>
        <td>{{ section.semester.code }}</td>
        <td>{{ section.capacity }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="4">暂无教学班</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="section">
  <h2>我的申请</h2>
  <table>
    <thead>
      <tr style="text-align:left; border-bottom:1px solid #e5e7eb;">
        <th>类型</th>
        <th>教学班</th>
        <th>状态</th>
        <th>提交时间</th>
        <th>审核记录</th>
      </tr>
    </thead>
    <tbody>
      {% for item in requests %}
      <tr style="border-bottom:1px solid #f1f5f9;">
        <td>{{ item.get_request_type_display }}</td>
        <td>{% if item.section %}{{ item.section.course.name }} ({{ item.section.semester.code }}){% else %}-{% endif %}</td>
        <td>{{ item.get_status_display }}</td>
        <td>{{ item.created_at|date:"Y-m-d H:i" }}</td>
        <td>
          {% with logs=item.logs.all %}
            {% if logs|length %}
              <ul style="margin:0; padding-left: 16px; color: var(--muted);">
                {% for log in logs %}
                  <li>{{ log.get_action_display }} by {{ log.actor }} - {{ log.created_at|date:"Y-m-d H:i" }} {% if log.note %}（{{ log.note }}）{% endif %}</li>
                {% endfor %}
              </ul>
            {% else %}
              -
            {% endif %}
          {% endwith %}
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="5">暂无申请记录</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="actions">
  <a class="button secondary" href="{% url 'force_password_change' %}">修改密码</a>
  <a class="muted-link" href="{% url 'logout' %}">退出登录</a>
</div>
{% endblock %}
