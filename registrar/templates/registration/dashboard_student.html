{% extends "base.html" %}
{% block title %}学生自助服务{% endblock %}
{% block content %}
<h1>学生自助服务</h1>
<p>报名、退课、重修、容量候补等都可在此发起。默认密码仍可通过“修改密码”入口更新。</p>

<div class="hint">
  <strong>快速说明：</strong>
  <ul>
    <li>报名/退课/候补申请会直接记录在系统中；重修、跨院、超学分、候补转正将进入审批流。</li>
    <li>提交后可在下方列表查看进度与历史审核意见。</li>
  </ul>
</div>

<form method="post">
  {% csrf_token %}
  {{ form.non_field_errors }}
  <label for="id_request_type">办理事项</label>
  {{ form.request_type }}
  <label for="id_section">关联教学班</label>
  {{ form.section }}
  <label for="id_reason">说明/备注</label>
  {{ form.reason }}
  <input class="button" type="submit" value="提交申请" />
</form>

<h2>我的申请</h2>
<table style="width:100%; border-collapse: collapse; margin-top: 12px;">
  <thead>
    <tr style="text-align:left; border-bottom:1px solid #e5e7eb;">
      <th>类型</th>
      <th>教学班</th>
      <th>状态</th>
      <th>提交时间</th>
      <th>审核记录</th>
    </tr>
  </thead>
  <tbody>
    {% for item in requests %}
    <tr style="border-bottom:1px solid #f1f5f9;">
      <td>{{ item.get_request_type_display }}</td>
      <td>{% if item.section %}{{ item.section.course.name }} ({{ item.section.semester.code }}){% else %}-{% endif %}</td>
      <td>{{ item.get_status_display }}</td>
      <td>{{ item.created_at|date:"Y-m-d H:i" }}</td>
      <td>
        {% with logs=item.logs.all %}
          {% if logs|length %}
            <ul style="margin:0; padding-left: 16px; color: var(--muted);">
              {% for log in logs %}
                <li>{{ log.get_action_display }} by {{ log.actor }} - {{ log.created_at|date:"Y-m-d H:i" }} {% if log.note %}（{{ log.note }}）{% endif %}</li>
              {% endfor %}
            </ul>
          {% else %}
            -
          {% endif %}
        {% endwith %}
      </td>
    </tr>
    {% empty %}
    <tr><td colspan="5">暂无申请记录</td></tr>
    {% endfor %}
  </tbody>
</table>

<div class="actions">
  <a class="button secondary" href="{% url 'force_password_change' %}">修改密码</a>
  <a class="muted-link" href="{% url 'logout' %}">退出登录</a>
</div>
{% endblock %}
