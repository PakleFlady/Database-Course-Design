{% extends "base.html" %}
{% block title %}学生自助服务{% endblock %}
{% block content %}
<h1>学生自助服务</h1>
<p>报名、退课、重修等都可在此发起。左侧概览提供 GPA、学分、审批进度与可选课程数量，方便你快速掌握当前状态。</p>

<style>
  .feature-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 12px;
    margin: 12px 0 20px;
  }
  .feature-card {
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 12px;
    background: #f8fafc;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .feature-card h3 { margin: 0; }
  .feature-card button {
    align-self: flex-start;
  }
  details.feature-panel {
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 10px 12px;
    margin-bottom: 14px;
    background: #fff;
  }
  details.feature-panel summary {
    cursor: pointer;
    font-weight: 600;
    list-style: none;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  details.feature-panel[open] {
    box-shadow: 0 6px 18px rgba(15, 23, 42, 0.07);
  }
  details.feature-panel summary::-webkit-details-marker { display: none; }
  details.feature-panel .panel-body { margin-top: 10px; }
</style>

<div class="grid two">
  <div class="stat-card">
    <div class="stat-label">当前 GPA</div>
    <div class="stat-value">{{ gpa|default:"--" }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">本学期计划学分</div>
    <div class="stat-value">{{ credit_load|default:0 }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">待审批申请</div>
    <div class="stat-value">{{ request_summary.pending }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">可选教学班</div>
    <div class="stat-value">{{ available_section_count }}</div>
  </div>
</div>

<div class="feature-grid">
  <div class="feature-card">
    <h3>个人档案</h3>
    <p class="muted">查看基础信息与联系方式。</p>
    <button class="button secondary" data-target="#panel-profile">打开界面</button>
  </div>
  <div class="feature-card">
    <h3>自助办理</h3>
    <p class="muted">发起跨院、超学分等审批。</p>
    <button class="button primary" data-target="#panel-selfservice">打开界面</button>
  </div>
  <div class="feature-card">
    <h3>课表与导出</h3>
    <p class="muted">展开查看本学期排课并导出。</p>
    <button class="button secondary" data-target="#panel-schedule">打开界面</button>
  </div>
  <div class="feature-card">
    <h3>成绩与重修</h3>
    <p class="muted">关注未通过课程与已选成绩。</p>
    <button class="button secondary" data-target="#panel-retake">打开界面</button>
  </div>
  <div class="feature-card">
    <h3>申请进度</h3>
    <p class="muted">查看历史审批与日志。</p>
    <button class="button secondary" data-target="#panel-requests">打开界面</button>
  </div>
  <div class="feature-card">
    <h3>快捷入口</h3>
    <p class="muted">前往选课中心或修改密码。</p>
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <a class="button primary" href="{% url 'student_enrollment' %}">选课中心</a>
      <a class="button secondary" href="{% url 'force_password_change' %}">修改密码</a>
    </div>
  </div>
</div>

<details class="feature-panel" id="panel-profile">
  <summary>个人档案</summary>
  <div class="panel-body">
    <div class="hint">
      <strong>{{ profile.user.get_full_name|default:profile.user.username }}</strong> · {{ profile.get_gender_display|default:"未填写" }}<br />
      <span class="muted">学院/专业：{{ profile.department.name|default:"-" }} / {{ profile.major|default:"-" }}</span><br />
      <span class="muted">班级：{{ profile.class_group|default:"未分配班级" }}</span><br />
      <span class="muted">联系方式：{{ profile.contact_email|default:"未填写邮箱" }} {% if profile.contact_phone %}/ {{ profile.contact_phone }}{% endif %}</span>
    </div>
  </div>
</details>

<details class="feature-panel" id="panel-selfservice">
  <summary>自助办理</summary>
  <div class="panel-body">
    <div class="hint">
      <strong>说明：</strong> 选课/退课已移至“选课中心”，此处仅用于提交重修、跨院、超学分等需审批的申请。
    </div>
    <form method="post">
      {% csrf_token %}
      {{ form.non_field_errors }}
      <label for="id_request_type">办理事项</label>
      {{ form.request_type }}
      <label for="id_section">关联教学班</label>
      {{ form.section }}
      <label for="id_reason">说明/备注</label>
      {{ form.reason }}
      <input class="button" type="submit" value="提交申请" />
    </form>
  </div>
</details>

<details class="feature-panel" id="panel-schedule">
  <summary>上课时间安排</summary>
  <div class="panel-body">
    <div style="display:flex; justify-content: space-between; align-items: center; gap: 12px; margin-bottom:8px;">
      <span class="muted">展开查看详细排课信息。</span>
      <a class="button secondary" href="{% url 'student_schedule_export' %}">导出课表</a>
    </div>
    <table>
      <thead>
        <tr style="text-align:left; border-bottom:1px solid #e5e7eb;">
          <th>星期</th>
          <th>时间</th>
          <th>课程</th>
          <th>学期</th>
          <th>地点</th>
        </tr>
      </thead>
      <tbody>
        {% for slot in schedule %}
        <tr style="border-bottom:1px solid #f1f5f9;">
          <td>{{ slot.get_day_of_week_display }}</td>
          <td>{{ slot.start_time }} - {{ slot.end_time }}</td>
          <td>{{ slot.section.course.code }} {{ slot.section.course.name }}</td>
          <td>{{ slot.section.semester.code }}</td>
          <td>{{ slot.location|default:"待定" }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="5">暂未有课表安排</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</details>

<details class="feature-panel" id="panel-retake">
  <summary>需关注/重修课程与成绩</summary>
  <div class="panel-body">
    <h3 style="margin-top:0;">需关注/重修课程</h3>
    <table>
      <thead>
        <tr style="text-align:left; border-bottom:1px solid #e5e7eb;">
          <th>课程</th>
          <th>学期</th>
          <th>状态</th>
          <th>成绩</th>
        </tr>
      </thead>
      <tbody>
        {% for enrollment in failed_enrollments %}
        <tr style="border-bottom:1px solid #f1f5f9;">
          <td>{{ enrollment.section.course.name }}</td>
          <td>{{ enrollment.section.semester.code }}</td>
          <td>{{ enrollment.get_status_display }}</td>
          <td>{{ enrollment.final_grade|default:"-" }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="4">暂无需重修的课程</td></tr>
        {% endfor %}
      </tbody>
    </table>

    <h3>已选课程与成绩</h3>
    <table>
      <thead>
        <tr style="text-align:left; border-bottom:1px solid #e5e7eb;">
          <th>课程</th>
          <th>学期</th>
          <th>状态</th>
          <th>成绩</th>
          <th>绩点</th>
        </tr>
      </thead>
      <tbody>
        {% for enrollment in enrollments %}
        <tr style="border-bottom:1px solid #f1f5f9;">
          <td>{{ enrollment.section.course.name }}</td>
          <td>{{ enrollment.section.semester.code }}</td>
          <td>{{ enrollment.get_status_display }}</td>
          <td>{{ enrollment.final_grade|default:"-" }}</td>
          <td>{{ enrollment.grade_points|default:"-" }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="5">暂未有选课记录</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</details>

<details class="feature-panel" id="panel-requests">
  <summary>我的申请与日志</summary>
  <div class="panel-body">
    <table>
      <thead>
        <tr style="text-align:left; border-bottom:1px solid #e5e7eb;">
          <th>类型</th>
          <th>教学班</th>
          <th>状态</th>
          <th>提交时间</th>
          <th>审核记录</th>
        </tr>
      </thead>
      <tbody>
        {% for item in requests %}
        <tr style="border-bottom:1px solid #f1f5f9;">
          <td>{{ item.get_request_type_display }}</td>
          <td>{% if item.section %}{{ item.section.course.name }} ({{ item.section.semester.code }}){% else %}-{% endif %}</td>
          <td>{{ item.get_status_display }}</td>
          <td>{{ item.created_at|date:"Y-m-d H:i" }}</td>
          <td>
            {% with logs=item.logs.all %}
              {% if logs|length %}
                <ul style="margin:0; padding-left: 16px; color: var(--muted);">
                  {% for log in logs %}
                    <li>{{ log.get_action_display }} by {{ log.actor }} - {{ log.created_at|date:"Y-m-d H:i" }} {% if log.note %}（{{ log.note }}）{% endif %}</li>
                  {% endfor %}
                </ul>
              {% else %}
                -
              {% endif %}
            {% endwith %}
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="5">暂无申请记录</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</details>

<div class="actions" style="justify-content: space-between; flex-wrap: wrap; gap: 12px;">
  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
    <a class="button secondary" href="{% url 'force_password_change' %}">修改密码</a>
    <a class="button primary" href="{% url 'student_enrollment' %}">进入选课中心</a>
  </div>
  <a class="muted-link" href="{% url 'logout' %}">退出登录</a>
</div>

<script>
  document.querySelectorAll('[data-target]').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const target = document.querySelector(btn.dataset.target);
      if (!target) return;
      target.open = true;
      target.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
  });
</script>
{% endblock %}
