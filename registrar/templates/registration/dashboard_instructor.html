{% extends "base.html" %}
{% block title %}教师工作台{% endblock %}
{% block content %}
<h1>教师工作台</h1>
<p>查看你负责的教学班、审批学生的重修/跨院/超学分/候补转正申请，并关注成绩填报锁定状态。</p>

<div class="hint">
  <ul>
    <li>若教学班“成绩填报锁定”为开启，则需联系管理员解锁后才能录入或修改成绩。</li>
    <li>审批操作会记录审核日志，便于后续追溯。</li>
  </ul>
</div>

<h2>我的教学班</h2>
<ul>
  {% for section in sections %}
  <li>{{ section.course.name }} - {{ section.semester.name }}（{{ section.section_number }}班）{% if section.grades_locked %} · 成绩已锁定{% else %} · 可录入成绩{% endif %}</li>
  {% empty %}
  <li>暂未分配教学班。</li>
  {% endfor %}
</ul>

<h2>选课名单/成绩录入</h2>
<table style="width:100%; border-collapse: collapse;">
  <thead>
    <tr style="text-align:left; border-bottom:1px solid #e5e7eb;">
      <th>学生</th>
      <th>课程</th>
      <th>学期</th>
      <th>状态</th>
      <th>成绩</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody>
    {% for enrollment in enrollments %}
    <tr style="border-bottom:1px solid #f1f5f9;">
      <td>{{ enrollment.student.user.get_full_name|default:enrollment.student.user.username }}</td>
      <td>{{ enrollment.section.course.name }}</td>
      <td>{{ enrollment.section.semester.code }}</td>
      <td>{{ enrollment.get_status_display }}</td>
      <td>{{ enrollment.final_grade|default:"-" }}</td>
      <td>
        <form method="post" action="{% url 'grade_update' enrollment.section_id %}" style="display:flex; gap:4px; align-items:center;">
          {% csrf_token %}
          <input type="hidden" name="enrollment_id" value="{{ enrollment.id }}" />
          <label class="sr-only" for="grade-{{ enrollment.id }}">成绩</label>
          <select name="final_grade" id="grade-{{ enrollment.id }}">
            <option value="">--</option>
            {% for code,label in enrollment.GRADE_CHOICES %}
            <option value="{{ code }}" {% if enrollment.final_grade == code %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
          <select name="status">
            {% for code,label in enrollment.STATUS_CHOICES %}
            <option value="{{ code }}" {% if enrollment.status == code %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
          <button class="button secondary" type="submit" {% if enrollment.section.grades_locked %}disabled{% endif %}>保存</button>
        </form>
      </td>
    </tr>
    {% empty %}
    <tr><td colspan="6">暂无选课记录</td></tr>
    {% endfor %}
  </tbody>
</table>

<h2>待我审核</h2>
<table style="width:100%; border-collapse: collapse;">
  <thead>
    <tr style="text-align:left; border-bottom:1px solid #e5e7eb;">
      <th>学生</th>
      <th>类型</th>
      <th>教学班</th>
      <th>提交时间</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody>
    {% for item in pending_requests %}
    <tr style="border-bottom:1px solid #f1f5f9;">
      <td>{{ item.student.user.username }}</td>
      <td>{{ item.get_request_type_display }}</td>
      <td>{{ item.section.course.name }} ({{ item.section.semester.code }})</td>
      <td>{{ item.created_at|date:"Y-m-d H:i" }}</td>
      <td><a class="button secondary" href="{% url 'approval_queue' %}">进入审批队列</a></td>
    </tr>
    {% empty %}
    <tr><td colspan="5">暂无待审核申请</td></tr>
    {% endfor %}
  </tbody>
</table>

<div class="actions">
  <a class="button secondary" href="{% url 'approval_queue' %}">审批队列</a>
  <a class="button secondary" href="{% url 'force_password_change' %}">修改密码</a>
  <a class="muted-link" href="{% url 'logout' %}">退出登录</a>
</div>
{% endblock %}
